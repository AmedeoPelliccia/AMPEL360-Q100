$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://ampel360.io/schemas/derivation/v1.0.0"
title: "KNU Derivation Metadata Schema"
description: |
  Schema for _derivation.yaml files that provide traceability lineage for KNU artifacts.
  Each _derivation.yaml file documents why a KNU exists, its parent KNOT, resolution 
  history, and downstream action references.
type: object
required:
  - schema_version
  - knu_id
  - derivation_lineage
  - lifecycle_binding
  - creation_record

properties:
  schema_version:
    type: string
    description: "Version of the _derivation.yaml schema"
    pattern: "^\\d+\\.\\d+\\.\\d+$"
    examples: ["1.0.0"]

  knu_id:
    type: object
    description: "KNU identifier with full ATA subject hierarchy and lifecycle binding"
    required:
      - legacy_id
      - normalized_id
      - ata_address
    properties:
      legacy_id:
        type: string
        pattern: "^KNU-\\d{2}-\\d{2}-\\d{3}-[A-Z]+-\\d{3}$"
      normalized_id:
        type: string
        pattern: "^KNU-\\d{2}-\\d{2}-\\d{3}-LC\\d{2}-\\d{2}-\\d{2}-\\d{2}-[A-Z0-9_]+$"
      ata_address:
        type: object
        required: [chapter, section, subject, sub_subject, sub_sub_subject]
        properties:
          chapter: {type: string, pattern: "^\\d{2}$"}
          section: {type: string, pattern: "^\\d{2}$"}
          subject: {type: string, pattern: "^\\d{2}$"}
          sub_subject: {type: string, pattern: "^\\d{2}$"}
          sub_sub_subject: {type: string, pattern: "^\\d{2}$"}

  derivation_lineage:
    type: object
    required: [parent_knot, derivation_type, rationale]
    properties:
      parent_knot:
        type: object
        required: [knot_id]
        properties:
          knot_id: {type: string, pattern: "^KNOT-\\d{2}-\\d{2}-\\d{3}$"}
      derivation_type:
        type: string
        enum: [BASELINE, TBD_RESOLUTION, DEPENDENCY, REGULATORY, DESIGN_DECISION, INTEGRATION, CERTIFICATION]
      rationale:
        type: string
        minLength: 20

  lifecycle_binding:
    type: object
    required: [lifecycle_category, rec]
    properties:
      lifecycle_category:
        type: string
        enum: [LC01, LC02, LC03, LC04, LC05, LC06, LC07, LC08, LC09, LC10, LC11, LC12, LC13, LC14]
      rec: {type: string}
      artifact_type:
        type: string
        enum: [REQ, ICD, ANA, TEST, CM, PUB, PLAN, SAF]
      artifact_class:
        type: string
        enum: [SSOT, CSDB]

  creation_record:
    type: object
    required: [created_utc, created_by]
    properties:
      created_utc: {type: string, format: date-time}
      created_by: {type: string}
