# ═══════════════════════════════════════════════════════════════════════════════
# _derivation.schema.yaml — KNU Derivation Metadata Schema Specification
# ═══════════════════════════════════════════════════════════════════════════════
# Purpose: Defines the schema for _derivation.yaml files that answer
#          "Why does this KNU exist?" and establish explicit traceability lineage.
#
# This schema implements the OPT-IN Framework Normalization Model:
#   - KNOT ID: KNOT-XX-XX-NNN (unchanged, no suffix)
#   - KNU ID: KNU_NNN_LCXX_DOMAIN_TYPE (lifecycle binding, no redundant ATA)
#   - TBD: Collocated with derivation metadata (folder-based lineage)
#   - Execution: KNT_UTC_timestamp/ (immutable, timestamped folders)
#   - Downstream: NODE_TASK_REFERENCE/ (explicit action tracking)
#
# Version: 1.0.0
# Last Updated: 2026-01-14
# Author: AMPEL360 Program Office
# ═══════════════════════════════════════════════════════════════════════════════

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://ampel360.io/schemas/derivation/v1.0.0"
title: "KNU Derivation Metadata Schema"
description: |
  Schema for _derivation.yaml files that provide traceability lineage for KNU artifacts.
  Each _derivation.yaml file documents why a KNU exists, its parent KNOT, resolution 
  history, and downstream action references.
type: object
required:
  - schema_version
  - knu_id
  - derivation_lineage
  - lifecycle_binding
  - creation_record

properties:
  # ─────────────────────────────────────────────────────────────────────────────
  # Schema Metadata
  # ─────────────────────────────────────────────────────────────────────────────
  schema_version:
    type: string
    description: "Version of the _derivation.yaml schema"
    pattern: "^\\d+\\.\\d+\\.\\d+$"
    examples: ["1.0.0"]

  # ─────────────────────────────────────────────────────────────────────────────
  # KNU Identity (Proposed Normalized Format)
  # ─────────────────────────────────────────────────────────────────────────────
  knu_id:
    type: object
    description: "KNU identifier with lifecycle binding"
    required:
      - legacy_id
      - normalized_id
    properties:
      legacy_id:
        type: string
        description: "Current KNU ID format (e.g., KNU-00-00-005-REQ-001)"
        pattern: "^KNU-\\d{2}-\\d{2}-\\d{3}-[A-Z]+-\\d{3}$"
        examples: ["KNU-00-00-005-REQ-001"]
      normalized_id:
        type: string
        description: |
          Proposed normalized KNU ID format with lifecycle binding:
          KNU_{KNOT_SEQ}_{LIFECYCLE}_{DOMAIN}_{TYPE}
        pattern: "^KNU_\\d{3}_LC\\d{2}_[A-Z_]+$"
        examples: ["KNU_005_LC02_UNIT_SYS_REQ"]
      title:
        type: string
        description: "Human-readable KNU title"
        examples: ["Unit System Requirements"]

  # ─────────────────────────────────────────────────────────────────────────────
  # Derivation Lineage (Answers: "Why does this KNU exist?")
  # ─────────────────────────────────────────────────────────────────────────────
  derivation_lineage:
    type: object
    description: "Traceability chain documenting why this KNU exists"
    required:
      - parent_knot
      - derivation_type
      - rationale
    properties:
      parent_knot:
        type: object
        description: "Parent KNOT identifier"
        required:
          - knot_id
        properties:
          knot_id:
            type: string
            description: "KNOT ID format (unchanged)"
            pattern: "^KNOT-\\d{2}-\\d{2}-\\d{3}$"
            examples: ["KNOT-00-00-005"]
          sequence_number:
            type: integer
            description: "Sequence number within ATA chapter (derived from KNOT ID)"
            minimum: 1
            examples: [5]
          title:
            type: string
            description: "KNOT problem statement title"
            examples: ["Unit Systems and Conversions"]
      
      derivation_type:
        type: string
        description: "How this KNU was derived"
        enum:
          - BASELINE          # Original baseline artifact from KNOT
          - TBD_RESOLUTION    # Spawned to resolve a TBD
          - DEPENDENCY        # Required by another KNU
          - REGULATORY        # Mandated by regulatory requirement
          - DESIGN_DECISION   # Result of trade study or design decision
          - INTEGRATION       # Cross-system integration requirement
          - CERTIFICATION     # Certification evidence requirement
        examples: ["BASELINE"]
      
      rationale:
        type: string
        description: "Human-readable explanation of why this KNU exists"
        minLength: 20
        examples:
          - "Required to establish program-wide unit conventions for consistent engineering calculations and certification evidence"
      
      spawned_by:
        type: object
        description: "If TBD_RESOLUTION, the TBD that spawned this KNU"
        properties:
          tbd_id:
            type: string
            description: "TBD identifier"
            examples: ["TBD-00-00-005-REQ-001-005"]
          tbd_description:
            type: string
            description: "Original TBD description"
            examples: ["Metadata schema for unit provenance"]
          resolution_date:
            type: string
            format: date
            description: "Date the TBD was resolved"
            examples: ["2026-01-13"]
          resolution_summary:
            type: string
            description: "Brief summary of how TBD was resolved"
            examples: ["Spawned KNU-00-00-005-ICD-002 for unit provenance metadata schema"]
      
      parent_knus:
        type: array
        description: "KNUs that this artifact depends on or extends"
        items:
          type: object
          required:
            - knu_id
            - relationship
          properties:
            knu_id:
              type: string
              examples: ["KNU-00-00-002-REQ-001"]
            relationship:
              type: string
              enum: [extends, depends_on, refines, implements]
            description:
              type: string
              examples: ["Document numbering conventions used in unit registries"]

  # ─────────────────────────────────────────────────────────────────────────────
  # Lifecycle Binding
  # ─────────────────────────────────────────────────────────────────────────────
  lifecycle_binding:
    type: object
    description: "Explicit lifecycle category binding (LC01-LC14)"
    required:
      - lifecycle_category
      - rec
    properties:
      lifecycle_category:
        type: string
        description: "Lifecycle category code"
        enum:
          - LC01  # Problem Statement
          - LC02  # System Requirements
          - LC03  # Safety Assessment
          - LC04  # Design Definition
          - LC05  # Analysis/Models
          - LC06  # Verification
          - LC07  # Validation
          - LC08  # Configuration Management
          - LC09  # Manufacturing
          - LC10  # Operations
          - LC11  # Publication - AMM
          - LC12  # Publication - Other
          - LC13  # Training
          - LC14  # Obsolescence
        examples: ["LC02"]
      rec:
        type: string
        description: "Responsible Engineering Category folder"
        examples: ["LC02_SYSTEM_REQUIREMENTS"]
      artifact_type:
        type: string
        description: "Type of artifact (REQ, ICD, ANA, TEST, CM, PUB, PLAN)"
        enum: [REQ, ICD, ANA, TEST, CM, PUB, PLAN, SAF]
        examples: ["REQ"]
      artifact_class:
        type: string
        description: "SSOT engineering evidence or CSDB publication"
        enum: [SSOT, CSDB]
        examples: ["SSOT"]

  # ─────────────────────────────────────────────────────────────────────────────
  # Creation Record (Immutable Execution Timestamp)
  # ─────────────────────────────────────────────────────────────────────────────
  creation_record:
    type: object
    description: "Immutable record of artifact creation"
    required:
      - created_utc
      - created_by
    properties:
      created_utc:
        type: string
        format: date-time
        description: "UTC timestamp of creation (immutable)"
        examples: ["2026-01-12T14:30:00Z"]
      created_by:
        type: string
        description: "Stakeholder who created the artifact"
        examples: ["STK_SE"]
      knt_folder:
        type: string
        description: "Immutable timestamped execution folder (if applicable)"
        pattern: "^KNT_\\d{4}-\\d{2}-\\d{2}T\\d{6}Z$"
        examples: ["KNT_2026-01-12T143000Z"]
      baseline_version:
        type: string
        description: "Version at creation"
        examples: ["I01-R01"]

  # ─────────────────────────────────────────────────────────────────────────────
  # TBD Resolution Record (Collocated Lineage)
  # ─────────────────────────────────────────────────────────────────────────────
  tbd_resolution:
    type: object
    description: "TBD resolution record collocated with the artifact"
    properties:
      resolved_tbds:
        type: array
        description: "TBDs resolved by this artifact"
        items:
          type: object
          required:
            - tbd_id
            - resolution_status
            - resolution_date
          properties:
            tbd_id:
              type: string
              examples: ["TBD-00-00-005-REQ-001-005"]
            original_description:
              type: string
              examples: ["Metadata schema for unit provenance"]
            resolution_status:
              type: string
              enum: [RESOLVED, DEFERRED, CANCELLED, SUPERSEDED]
            resolution_date:
              type: string
              format: date
            resolution_summary:
              type: string
            evidence_location:
              type: string
              description: "Path to resolution evidence within the artifact"
              examples: ["Section 5.3.4"]
      
      spawned_tbds:
        type: array
        description: "New TBDs created during artifact development"
        items:
          type: object
          properties:
            tbd_id:
              type: string
            description:
              type: string
            owner:
              type: string
            target_date:
              type: string
              format: date
            status:
              type: string
              enum: [OPEN, IN_PROGRESS, BLOCKED]

  # ─────────────────────────────────────────────────────────────────────────────
  # Node Task Reference (Downstream Action Tracking)
  # ─────────────────────────────────────────────────────────────────────────────
  node_task_reference:
    type: object
    description: "Explicit downstream action tracking"
    properties:
      downstream_artifacts:
        type: array
        description: "KNUs/artifacts that this artifact spawns or triggers"
        items:
          type: object
          required:
            - target_knu_id
            - relationship
            - status
          properties:
            target_knu_id:
              type: string
              examples: ["KNU-00-00-005-ICD-001"]
            relationship:
              type: string
              enum:
                - spawns          # This artifact creates the target
                - triggers        # This artifact triggers work on target
                - validates       # This artifact validates the target
                - implements      # Target implements this artifact
                - extends         # Target extends this artifact
            trigger_condition:
              type: string
              description: "Condition that triggers downstream work"
              examples: ["Upon REQ-001 approval"]
            status:
              type: string
              enum: [PENDING, IN_PROGRESS, COMPLETE, BLOCKED]
            notes:
              type: string
      
      execution_log:
        type: array
        description: "Timestamped execution events"
        items:
          type: object
          properties:
            timestamp_utc:
              type: string
              format: date-time
            event_type:
              type: string
              enum: [CREATED, UPDATED, REVIEWED, APPROVED, SPAWNED, CLOSED]
            actor:
              type: string
            description:
              type: string

  # ─────────────────────────────────────────────────────────────────────────────
  # Traceability Links
  # ─────────────────────────────────────────────────────────────────────────────
  traceability:
    type: object
    description: "Bidirectional traceability links"
    properties:
      upstream:
        type: array
        description: "References to parent/source artifacts"
        items:
          type: object
          required:
            - ref_id
            - ref_type
          properties:
            ref_id:
              type: string
            ref_type:
              type: string
              enum: [KNOT, KNU, TBD, REGULATION, STANDARD]
            description:
              type: string
      downstream:
        type: array
        description: "References to child/target artifacts"
        items:
          type: object
          required:
            - ref_id
            - ref_type
          properties:
            ref_id:
              type: string
            ref_type:
              type: string
              enum: [KNU, PUB, TEST, CERT_EVIDENCE]
            description:
              type: string

# ═══════════════════════════════════════════════════════════════════════════════
# Schema Examples
# ═══════════════════════════════════════════════════════════════════════════════
examples:
  - schema_version: "1.0.0"
    knu_id:
      legacy_id: "KNU-00-00-005-REQ-001"
      normalized_id: "KNU_005_LC02_UNIT_SYS_REQ"
      title: "Unit System Requirements"
    derivation_lineage:
      parent_knot:
        knot_id: "KNOT-00-00-005"
        sequence_number: 5
        title: "Unit Systems and Conversions"
      derivation_type: "BASELINE"
      rationale: "Required to establish program-wide unit conventions for consistent engineering calculations, data storage, and certification evidence"
    lifecycle_binding:
      lifecycle_category: "LC02"
      rec: "LC02_SYSTEM_REQUIREMENTS"
      artifact_type: "REQ"
      artifact_class: "SSOT"
    creation_record:
      created_utc: "2026-01-12T14:30:00Z"
      created_by: "STK_SE"
      baseline_version: "I01-R01"
